<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Search as you type is an interesting feature of modern search engines. The basic idea of this feature is to give user instant feedback as they type. Implementation of this feature can vary; sometimes it can be based on popular searches and other times just a preview of results.
Elasticsearch has a lot of natural language text analysis options that makes it possible to be used as a part of search as you type system.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Elasticsearch - Search As You Type • Adnan Ahmed'>
<meta property='og:description' content='Search as you type is an interesting feature of modern search engines. The basic idea of this feature is to give user instant feedback as they type. Implementation of this feature can vary; sometimes it can be based on popular searches and other times just a preview of results.
Elasticsearch has a lot of natural language text analysis options that makes it possible to be used as a part of search as you type system.'>
<meta property='og:url' content='https://adnanahmed.info/posts/elasticsearch-search-as-you-type/'>
<meta property='og:site_name' content='Adnan Ahmed'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='elasticsearch'><meta property='article:tag' content='autocomplete'><meta property='article:published_time' content='2017-01-28T00:00:00&#43;01:00'/><meta property='article:modified_time' content='2017-01-28T00:00:00&#43;01:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.49.2" />

  <title>Elasticsearch - Search As You Type • Adnan Ahmed</title>
  <link rel='canonical' href='https://adnanahmed.info/posts/elasticsearch-search-as-you-type/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.4267b3fa.css'><link rel='stylesheet' href='/css/custom.css'><link rel='stylesheet' href='/css/highlight.github.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56161851-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>


<body class='page type-posts'>

  <div class='site'>

    <a class='screen-reader-text' href='#content'>Skip to Content</a>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='/posts'>Posts</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Adnan Ahmed</p><p class='desc site-desc'>Engineer, Designer, Explorer, Opensourcerer, Educator, Lifelong Learner, Lead Engineer @tajawalae Available for Freelance Work</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Elasticsearch - Search As You Type</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2017-01-28T00:00:00&#43;01:00'>2017-01-28</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
6 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p>Search as you type is an interesting feature of modern search engines. The basic idea of this feature is to give user instant feedback as they type. Implementation of this feature can vary; sometimes it can be based on popular searches and other times just a preview of results.</p>

<p>Elasticsearch has a lot of natural language text analysis options that makes it possible to be used as a part of search as you type system. This article is going to be a drill down on how to implement search as you type using Elasticsearch that will search on movies database fulfilling the below requirements.</p>

<ul>
<li><strong>Partial word matching</strong>: The query must match partial words. So typing &ldquo;Capta Civil War&rdquo; should return results containing &ldquo; Captain Civil War&rdquo; or &ldquo;Captain America Civil War&rdquo; or &ldquo;Captain America&rsquo;s: Civilian War&rdquo; etc.</li>
<li><strong>Grouping</strong>: The results must be grouped by the year</li>
</ul>

<p>Note that I am not going to describe how to setup elasticsearch in this article and it is just going to be the details on how to make &ldquo;Search as you type&rdquo; service.</p>

<h2 id="key-components">Key Components</h2>

<p>Lets begin with the key components that we will use for the search:</p>

<h3 id="a-tokenizer">a. Tokenizer</h3>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" target="_blank">Tokenizing</a> is a process of scanning a string of characters as the user types and converting that character string into a list of words. Where each item is called <code>token</code>. During parsing we wish to deal with tokens as its easier and faster to deal with tokens. So to parse string we must find word boundaries and elasticsearch has plenty of built in tokenizers that can be used. For example a standard tokenizer will do following:</p>

<pre><code>Star Trek Beyond
-&gt; Applying Tokenizer -&gt;
[Star] [Trek] [Beyond]
</code></pre>

<p>Elasticsearch has a lot of built-in ones for example <code>edgeNGram</code>, <code>nGram</code>, <code>whitespace</code> etc. For our use-case, we are going to rely upon the built-in tokenizer called <code>edgeNGram</code></p>

<p><code>edgeNGram</code> tokenizer is useful for &ldquo;as you type&rdquo; queries. It only generate <code>nGrams</code> from the beginning of the words like word <code>brown</code> is tokenized into</p>

<pre><code>[b] [br] [bro] [brown]
</code></pre>

<p>We are going to rely upon the following properties of the tokenizer</p>

<ul>
<li><strong><code>min_gram</code>/<code>max_gram</code></strong> to control the minimum and maximum length of characters in a gram.</li>
<li><strong><code>token_chars</code></strong> for the characters to keep; it allows <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-edgengram-tokenizer.html#_configuration_17" target="_blank">five different character classes</a> to be specified as &ldquo;characters to keep&rdquo;. Elasticsearch will split on character classes not specified. If you don&rsquo;t specify any character classes, then all characters are kept.</li>
</ul>

<p>Lets take an example for tokenization:</p>

<pre><code>Query: `into the forest`

Filter:
&quot;edge_ngram_tokenizer&quot;:{
   &quot;type&quot;:&quot;edgeNGram&quot;,
   &quot;min_gram&quot;:&quot;2&quot;,
   &quot;max_gram&quot;:&quot;20&quot;,
   &quot;token_chars&quot;:[
      &quot;letter&quot;,        // Do not split on letters and consider words only
      &quot;digit&quot;          // Do not split on digits e.g. `21 Jump street` to not split `21` i.e resulting in `[2]` and `[1]`
   ]
}

Result: [in] [to] [the] [for] [forest]
</code></pre>

<h3 id="b-token-filters">b. Token Filters</h3>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenfilters.html" target="_blank">Token filters</a> basically work on token streams from a tokenizer and can modify (e.g. <code>lowercase</code>), delete (e.g. remove <code>stopwords</code>) or add (e.g. add <code>synonyms</code>) tokens.</p>

<p>Elasticsearch offers a plenty of built-in token filters which can be used to build custom analyzers. We are going to use below filters for our usecase:</p>

<ul>
<li><code>lowercase</code> that converts all token into lowercase.</li>
<li><code>asciifolding</code> that converts non ASCII characters into there equivalent 127 ASCII characters like <code>Café Society</code> into <code>Cafe Society</code> etc</li>
</ul>

<h3 id="c-analyzer">c. Analyzer</h3>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" target="_blank">Analyzers</a> are the way through which <code>Lucene</code> (java based search engine that is the backbone of elastic search) processes and indexes the data. Each analyzer is composed of following</p>

<ul>
<li>One Tokenizer</li>
<li>Zero or more Token/Char filters</li>
</ul>

<p>Here is how the analyzer that I have created for our implementation looks like:</p>

<pre><code>&quot;nGram_analyzer&quot;:{
   &quot;type&quot;:&quot;custom&quot;,
   &quot;tokenizer&quot;:&quot;edge_ngram_tokenizer&quot;,
   &quot;filter&quot;:[
      &quot;lowercase&quot;,
      &quot;asciifolding&quot;
   ]
}
</code></pre>

<p>I decided to name it <code>nGram_analyzer</code> but you can name it anything that you want. First of all it applies the given tokenizer <code>edge_ngram_tokenizer</code> on the search text and then given token filters. The main purpose of it is to do partial matching on the given query string.</p>

<h2 id="creating-index-and-types">Creating Index and Types</h2>

<p>Combining all of the above i.e. tokenizer, filter and analyzer first of all we will create an index. While creating an index we specify the mapping. For example, here we are creating a <code>movie</code> type with properties <code>display_name</code> and <code>year</code>. With each property we can specify an analyzer which will be used by elasticsearch to filter. Here is what our sample mapping looks like</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;movie&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
        <span style="color:#f92672">&#34;properties&#34;</span>: {
            <span style="color:#f92672">&#34;display_name&#34;</span>: {
                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>,
                <span style="color:#f92672">&#34;analyzer&#34;</span>: <span style="color:#e6db74">&#34;nGram_analyzer&#34;</span>
            },
            <span style="color:#f92672">&#34;year&#34;</span>: {
                <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>
            }
        }
    }</code></pre></div>
<p>Putting it all togeter we have below script to create an index called <code>entertainment_index</code> having the type <code>movie</code> with the above said properties.</p>

<pre><code>curl -XPUT &quot;http://localhost:9200/entertainment_index/&quot; -d'
{
   &quot;settings&quot;:{
      &quot;analysis&quot;:{
         &quot;filter&quot;:{
            &quot;nGram_filter&quot;:{
               &quot;type&quot;:&quot;edgeNGram&quot;,
               &quot;min_gram&quot;:1,
               &quot;max_gram&quot;:20,
               &quot;token_chars&quot;:[
                  &quot;letter&quot;,
                  &quot;digit&quot;
               ]
            }
         },
         &quot;tokenizer&quot;:{
            &quot;edge_ngram_tokenizer&quot;:{
               &quot;type&quot;:&quot;edgeNGram&quot;,
               &quot;min_gram&quot;:&quot;1&quot;,
               &quot;max_gram&quot;:&quot;20&quot;,
               &quot;token_chars&quot;:[
                  &quot;letter&quot;,
                  &quot;digit&quot;
               ]
            }
         },
         &quot;analyzer&quot;:{
            &quot;nGram_analyzer&quot;:{
               &quot;type&quot;:&quot;custom&quot;,
               &quot;tokenizer&quot;:&quot;edge_ngram_tokenizer&quot;,
               &quot;filter&quot;:[
                  &quot;lowercase&quot;,
                  &quot;asciifolding&quot;
               ]
            }
         }
      }
   },
   &quot;mappings&quot;:{
      &quot;movie&quot;:{
         &quot;properties&quot;:{
            &quot;display_name&quot;:{
               &quot;type&quot;:&quot;text&quot;,
               &quot;analyzer&quot;:&quot;nGram_analyzer&quot;
            },
            &quot;year&quot;: {
              &quot;type&quot;: &quot;keyword&quot;
            }
         }
      }
   }
}'
</code></pre>

<h2 id="populating-sample-data">Populating Sample Data</h2>

<p>Below is how the HTTP request to populate data looks like</p>

<pre><code>PUT /{index_name}/{type}/{id_to_assign:optional}
</code></pre>

<p>Lets add some sample data for the testing purposes.</p>

<pre><code>curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/1&quot; -d'
{
   &quot;display_name&quot;: &quot;X-Men Origins: Wolverine&quot;,
   &quot;year&quot;: 2009
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/2&quot; -d'
{
   &quot;display_name&quot;: &quot;X-Men: First Class&quot;,
   &quot;year&quot;: 2011
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/3&quot; -d'
{
   &quot;display_name&quot;: &quot;Zombieland&quot;,
   &quot;year&quot;: 2009
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/4&quot; -d'
{
   &quot;display_name&quot;: &quot;Monsters University&quot;,
   &quot;year&quot;: 2013
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/5&quot; -d'
{
   &quot;display_name&quot;: &quot;Monsters&quot;,
   &quot;year&quot;: 2010
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/6&quot; -d'
{
   &quot;display_name&quot;: &quot;Lost in London&quot;,
   &quot;year&quot;: 2017
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/7&quot; -d'
{
   &quot;display_name&quot;: &quot;London Spy&quot;,
   &quot;year&quot;: 2015
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/8&quot; -d'
{
   &quot;display_name&quot;: &quot;London Road&quot;,
   &quot;year&quot;: 2015
}'
curl -XPUT &quot;http://localhost:9200/entertainment_index/movie/9&quot; -d'
{
   &quot;display_name&quot;: &quot;London Fields&quot;,
   &quot;year&quot;: 2017
}'
</code></pre>

<h2 id="applying-search">Applying Search</h2>

<p>Here is how the search request looks like</p>

<pre><code>POST /{index}/{type}/_search
</code></pre>

<p>Now let&rsquo;s search against the stored data and test if we are getting the required results.</p>

<pre><code>curl -XPOST &quot;http://localhost:9200/entertainment_index/movie/_search&quot; -d'
{
    &quot;aggs&quot;: {
        &quot;year&quot;: {
            &quot;terms&quot;: {
                &quot;field&quot;: &quot;year&quot;
            },
            &quot;aggs&quot;: {
                &quot;group_docs&quot;: {
                    &quot;top_hits&quot;: {
                        &quot;size&quot;: 10
                    }
                }
            }
        }
    },
    &quot;query&quot;: {
        &quot;match&quot;: {
            &quot;display_name&quot;: {
                &quot;operator&quot;: &quot;and&quot;,
                &quot;query&quot;: &quot;london&quot;
            }
        }
    }
}'
</code></pre>

<p><code>aggs</code> specifies the grouping of results based on the <code>year</code> and limits to top 10 results from each of the groups. And in match <code>operator: and</code> means that the complete input string must be part of movie name and <code>query</code> is the user input. After running the above query you will get following results.</p>

<pre><code>2015
    London Spy
    London Road
2017
    Lost in London
    London Fields
</code></pre>

<p>And this is how we can implement &ldquo;search as you type&rdquo; service. Follow up with the questions and comments in the section below. Also, I would love to hear how you are using elasticsearch in your system.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/elasticsearch/'>elasticsearch</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/elasticsearch/'>elasticsearch</a>, <a class='tag' href='/tags/autocomplete/'>autocomplete</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/simple-factory-pattern/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Simple Factory Pattern</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/c-style-comments-in-elasticsearch-mapping/'>
        <span class='screen-reader-text'>Next post: </span>Elasticsearch - C Style Comments In Mapping<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "adnanahmed-info" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/idnan' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/idnan_se' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='https://instagram.com/idnan.ahmed' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Instagram account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
  <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
  <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:idnan.se@gmail.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/adnaanahmed' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2017-2018 Adnan Ahmed </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.59f76c44.js'></script><script src='/js/custom.js'></script><script src='/js/highlight.pack.js'></script><script src='/js/highlight-trigger.js'></script>

</body>

</html>

